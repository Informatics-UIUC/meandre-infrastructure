<?xml version="1.0" encoding="UTF-8"?>
<project name="Meandre-Core" basedir="." default="compile">
    <!-- import properties (app settings, classpath, jar file locations) -->
    <import file="properties.xml"/>

    <target name="init" description="Defines custom tasks">
        <!-- Ensure that Ant 1.7+ is being used -->
        <available classname="org.apache.tools.ant.DynamicAttribute" property="ant-1.7.0"/>
        <fail unless="ant-1.7.0" message="Ant 1.7.0 for faster unit testing"/>
    </target>

    <!-- prepare -->
    <target name="prepare" depends="init" description="Creates target directories">
        <!-- Check timestamp on files -->
        <tstamp/>
        <tstamp>
            <format property="copyright.year" pattern="yyyy"/>
        </tstamp>
        <echo message="Preparing build target '${build.dir}'"/>
        <mkdir dir="${build.dir}"/>
        <echo message="Preparing target directory '${dist.dir}'"/>
        <mkdir dir="${dist.dir}"/>
        <echo message="Preparing test directory '${test.dir}'"/>
        <mkdir dir="${test.dir}"/>
        <echo message="Preparing test data directory '${test.dir}/data'"/>
        <mkdir dir="${test.dir}/data"/>
    </target>


    <!-- compile -->
    <target name="compile" depends="prepare" description="Compiles source code">
        <echo>Compiling Core and Test...</echo>
        <echo>Junit cp: ${junit.jar}</echo>
        <javac srcdir="${basedir}" destdir="${build.dir}/" debug="${compile.debug}"
               deprecation="${compile.deprecation}" optimize="${compile.optimize}"
               classpathref="meandre.core.classpath" >
            <include name="**/*.java"/>
        </javac>
    </target>

    <!-- dist -->
    <target name="dist" depends="compile" description="Creates jar distribution">
        <!-- Create jar distribution -->
        <jar destfile="${dist.dir}/${app.name}-all.jar">
            <manifest>
                <attribute name="Build-Version" value="${build.version}"/>
            </manifest>
            <fileset dir="${build.dir}">
            </fileset>
        </jar>
        <jar destfile="${dist.dir}/${app.name}-core.jar">
            <manifest>
                <attribute name="Build-Version" value="${build.version}"/>
            </manifest>
            <fileset dir="${build.dir}">
                <include name="**/core/**/*.class"/>
                <include name="**/core/**/*.properties"/>
                <include name="**/core/**/*.xml"/>
            </fileset>
        </jar>

        <jar destfile="${dist.dir}/${app.name}-ws.jar">
            <manifest>
                <attribute name="Build-Version" value="${build.version}"/>
            </manifest>
            <fileset dir="${build.dir}">
                <include name="**/webservices/**/*.class"/>
                <include name="**/webservices/**/*.properties"/>
                <include name="**/webservices/**/*.xml"/>
            </fileset>
        </jar>

        <jar destfile="${dist.dir}/${app.name}-webui.jar">
            <manifest>
                <attribute name="Build-Version" value="${build.version}"/>
            </manifest>
            <fileset dir="${build.dir}">
                <include name="**/webui/**/*.class"/>
                <include name="**/webui/**/*.properties"/>
                <include name="**/webui/**/*.xml"/>
            </fileset>
        </jar>

        <jar destfile="${dist.dir}/${app.name}-componentdemo.jar">
            <manifest>
                <attribute name="Build-Version" value="${build.version}"/>
            </manifest>
            <fileset dir="${build.dir}">
                <include name="**/demo/**/*.class"/>
                <include name="**/demo/**/*.properties"/>
                <include name="**/demo/**/*.xml"/>
            </fileset>
        </jar>

        <jar destfile="${dist.dir}/${app.name}-main.jar">
            <manifest>
                <attribute name="Build-Version" value="${build.version}"/>
            </manifest>
            <fileset dir="${build.dir}">
                <exclude name="**/demo/**/*.class"/>
                <exclude name="**/demo/**/*.properties"/>
                <exclude name="**/demo/**/*.xml"/>
                <exclude name="**/webui/**/*.class"/>
                <exclude name="**/webui/**/*.properties"/>
                <exclude name="**/webui/**/*.xml"/>
                <exclude name="**/webservices/**/*.class"/>
                <exclude name="**/webservices/**/*.properties"/>
                <exclude name="**/webservices/**/*.xml"/>
                <exclude  name="**/core/**/*.class"/>
                <exclude  name="**/core/**/*.properties"/>
                <exclude  name="**/core/**/*.xml"/>
            </fileset>
        </jar>
    </target>

    <!-- clean -->
    <target name="clean" description="Removes build artifacts">
        <echo level="info">Cleaning build and distribution directories</echo>
        <delete dir="${build.dir}"/>
        <delete dir="${dist.dir}"/>
    </target>

    <!-- run-tests -->
    <target name="run-tests" depends="dist" description="Runs tests">
        <junit printsummary="yes" forkmode="once" errorProperty="test.failed"
               failureProperty="test.failed" fork="${junit.fork}" showoutput="${junit.showoutput}">
            <jvmarg value="-Duser.language=en"/>

            <classpath>
                <path refid="meandre.core.classpath"/>
                <pathelement location="${build.dir}"/>
                <pathelement path="${java.class.path}"/>
                <!-- For .properties and .xml files -->
                <pathelement path="src"/>
            </classpath>

            <formatter type="xml"/>
            <formatter type="brief" usefile="false"/>
            <batchtest todir="${test.dir}/data">
                <fileset dir="${test.src}">
                    <include name="**/*Test.java"/>
                </fileset>
            </batchtest>
        </junit>
    </target>

    <!-- test-reports -->
    <target name="test-reports" description="Generates test reports">
        <mkdir dir="${test.dir}/reports"/>
        <junitreport todir="${test.dir}">
            <fileset dir="${test.dir}/data">
                <include name="TEST-*.xml"/>
            </fileset>
            <report format="noframes" todir="${test.dir}/reports"/>
        </junitreport>
        <echo level="info"> Test reports generated at ${test.dir}/reports </echo>
    </target>

    <!-- run-core -->
    <target name="run" depends="dist" description="Runs the default Meandre-Core server">
        <echo level="info">Run the default Meandre-Core server</echo>
        <java classname="org.meandre.webservices.WSCoreBootstrapper">
            <classpath refid="meandre.core.classpath"/>
            <classpath>
                <pathelement location="${dist.dir}/${app.name}-core.jar"/>
                <pathelement location="${dist.dir}/${app.name}-ws.jar"/>
                <pathelement location="${dist.dir}/${app.name}-webui.jar"/>
                <pathelement location="${dist.dir}/${app.name}-componentdemo.jar"/>
                <pathelement location="${dist.dir}/${app.name}-main.jar"/>
            </classpath>
        </java>
    </target>

	<target name="clean-store"
		depends=""
		description="Deletes the MeandreStore directory, which contains the database of all installed (\'uploaded\') components and flows">
        
		<delete dir="MeandreStore"/>

	</target>
	<!---        Documentation (Javadocs)       -->
	<target name="javadoc"
		description="build the documentation. (expect lots of warnings when run - don't worry about them)" >

		<javadoc 
			sourcepath="${src}/"
			maxmemory="512m" 
			access="private"
			windowtitle="Meandre Core API"
			author="true" 
			use="true"
			destdir="${doc.dir}/"/>
	</target>
</project>
